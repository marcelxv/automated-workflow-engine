name: CI

on:
  push:
    branches: [ main ]
    paths:
      - 'workflows/**/*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'workflows/**/*.json'
  workflow_dispatch:

jobs:
  deploy-workflows:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Dependencies
      run: |
        npm init -y
        npm install ajv ajv-formats glob

    - name: Run Validation
      id: validate
      run: |
        if node scripts/validate-workflows.js ./workflows; then
          echo "status=success" >> "$GITHUB_OUTPUT"
        else
          echo "status=failure" >> "$GITHUB_OUTPUT"
          exit 1
        fi

    - name: Authenticate with Orkes
      if: steps.validate.outputs.status == 'success'
      id: authenticate
      uses: fjogeleit/http-request-action@v1.9.1
      with:
        url: 'https://foodready-prod.orkesconductor.io/api/auth/login'
        method: 'POST'
        contentType: 'application/json'
        data: '{"keyId": "${{ secrets.ORKES_REPO_KEY }}", "keySecret": "${{ secrets.ORKES_REPO_SECRET }}"}'

    - name: Deploy Schemas
      if: steps.validate.outputs.status == 'success'
      uses: fjogeleit/http-request-action@v1.9.1
      with:
        url: 'https://foodready-prod.orkesconductor.io/api/metadata/workflow/schema'
        method: 'PUT'
        customHeaders: '{"X-Authorization": "${{ fromJson(steps.authenticate.outputs.response).token }}"}'
        contentType: 'application/json'
        files: '["workflows/**/*_schema.json"]'

    - name: Deploy Workflows
      if: steps.validate.outputs.status == 'success'
      uses: fjogeleit/http-request-action@v1.9.1
      with:
        url: 'https://foodready-prod.orkesconductor.io/api/metadata/workflow'
        method: 'PUT'
        customHeaders: '{"X-Authorization": "${{ fromJson(steps.authenticate.outputs.response).token }}"}'
        contentType: 'application/json'
        files: '["workflows/**/*.json", "!workflows/**/*_schema.json", "!workflows/**/*_payload.json"]'

    - name: Report Status
      if: always()
      run: |
        if [[ "${{ steps.validate.outputs.status }}" == "success" ]]; then
          echo "✅ Workflow deployment completed successfully"
        else
          echo "❌ Workflow deployment failed"
          echo "Check validation results and credentials"
          exit 1
        fi