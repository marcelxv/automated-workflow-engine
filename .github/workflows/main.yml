name: CI

on:
  push:
    branches: [ main ]
    paths:
      - 'workflows/**/*.json'
  pull_request:
    branches: [ main ]
    paths:
      - 'workflows/**/*.json'
  workflow_dispatch:

jobs:
  deploy-workflows:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'

    - name: Install Dependencies
      run: |
        npm install ajv ajv-formats glob --no-package-lock

    - name: Run Validation
      id: validate
      run: |
        VALIDATION_OUTPUT=$(node scripts/validate-workflows.js ./workflows)
        echo "$VALIDATION_OUTPUT"
        if echo "$VALIDATION_OUTPUT" | grep -q "Total Workflows:"; then
          if echo "$VALIDATION_OUTPUT" | grep -q "Warnings:"; then
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "status=success" >> $GITHUB_OUTPUT
          fi
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Authenticate with Orkes
      id: auth
      uses: fjogeleit/http-request-action@v1.9.1
      with:
        url: 'https://foodready-prod.orkesconductor.io/api/token'
        method: 'POST'
        contentType: 'application/json'
        data: >
          {
            "keyId": "${{ secrets.ORKES_REPO_KEY }}",
            "keySecret": "${{ secrets.ORKES_REPO_SECRET }}"
          }

    - name: Check and Deploy Schemas
      if: success() && steps.auth.outputs.response != ''
      run: |
        TOKEN=$(echo '${{ steps.auth.outputs.response }}' | jq -r '.token')
        if [ -z "$TOKEN" ] || [ "$TOKEN" = "null" ]; then
          echo "‚ùå Failed to extract auth token"
          exit 1
        fi

        echo "üîç Finding schema files..."
        find workflows -type f -name "*_schema.json" | while read schema_file; do
          echo "üìã Processing schema: $schema_file"
          SCHEMA_NAME=$(jq -r '.name' "$schema_file")
          SCHEMA_VERSION=$(jq -r '.version' "$schema_file")
          
          # Check if schema exists
          EXISTING_SCHEMA=$(curl -s -H "X-Authorization: $TOKEN" \
            "https://foodready-prod.orkesconductor.io/api/metadata/workflow/schema/$SCHEMA_NAME")
          
          if [[ "$EXISTING_SCHEMA" != *"not found"* ]] && [[ ! -z "$EXISTING_SCHEMA" ]]; then
            EXISTING_VERSION=$(echo "$EXISTING_SCHEMA" | jq -r '.version')
            if [ "$EXISTING_VERSION" -ge "$SCHEMA_VERSION" ]; then
              echo "‚ö†Ô∏è Schema $SCHEMA_NAME version $SCHEMA_VERSION already exists with same or higher version ($EXISTING_VERSION). Skipping."
              continue
            fi
          fi
          
          echo "üì§ Deploying schema: $schema_file (v$SCHEMA_VERSION)"
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Authorization: $TOKEN" \
            -d @"$schema_file" \
            -w "\n%{http_code}" \
            "https://foodready-prod.orkesconductor.io/api/metadata/workflow/schema")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          CONTENT=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Successfully deployed schema: $schema_file"
          elif [ "$HTTP_CODE" = "409" ]; then
            echo "‚ö†Ô∏è Schema conflict: $CONTENT"
          else
            echo "‚ùå Failed to deploy schema: $schema_file"
            echo "Status: $HTTP_CODE"
            echo "Response: $CONTENT"
            exit 1
          fi
        done

    - name: Check and Deploy Workflows
      if: success() && steps.auth.outputs.response != ''
      run: |
        TOKEN=$(echo '${{ steps.auth.outputs.response }}' | jq -r '.token')
        
        echo "üîç Finding workflow files..."
        find workflows -type f -name "*.json" ! -name "*_schema.json" ! -name "*_payload.json" | while read workflow_file; do
          echo "üìã Processing workflow: $workflow_file"
          WORKFLOW_NAME=$(jq -r '.name' "$workflow_file")
          WORKFLOW_VERSION=$(jq -r '.version' "$workflow_file")
          
          # Check if workflow exists
          EXISTING_WORKFLOW=$(curl -s -H "X-Authorization: $TOKEN" \
            "https://foodready-prod.orkesconductor.io/api/metadata/workflow/$WORKFLOW_NAME?version=$WORKFLOW_VERSION")
          
          if [[ "$EXISTING_WORKFLOW" != *"not found"* ]] && [[ ! -z "$EXISTING_WORKFLOW" ]]; then
            echo "‚ö†Ô∏è Workflow $WORKFLOW_NAME version $WORKFLOW_VERSION already exists. Updating..."
          fi
          
          echo "üì§ Deploying workflow: $workflow_file (v$WORKFLOW_VERSION)"
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "X-Authorization: $TOKEN" \
            -d @"$workflow_file" \
            -w "\n%{http_code}" \
            "https://foodready-prod.orkesconductor.io/api/metadata/workflow")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          CONTENT=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            echo "‚úÖ Successfully deployed workflow: $workflow_file"
          elif [ "$HTTP_CODE" = "409" ]; then
            echo "‚ö†Ô∏è Workflow conflict: $CONTENT"
            # Try update if conflict
            RESPONSE=$(curl -s -X PUT \
              -H "Content-Type: application/json" \
              -H "X-Authorization: $TOKEN" \
              -d @"$workflow_file" \
              -w "\n%{http_code}" \
              "https://foodready-prod.orkesconductor.io/api/metadata/workflow")
            
            HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
            if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
              echo "‚úÖ Successfully updated workflow: $workflow_file"
            else
              echo "‚ùå Failed to update workflow: $workflow_file"
              echo "Status: $HTTP_CODE"
              echo "Response: $CONTENT"
              exit 1
            fi
          else
            echo "‚ùå Failed to deploy workflow: $workflow_file"
            echo "Status: $HTTP_CODE"
            echo "Response: $CONTENT"
            exit 1
          fi
        done

    - name: Report Status
      if: always()
      run: |
        echo "=== Deployment Summary ==="
        echo ""
        echo "Validation Status: ${{ steps.validate.outputs.status }}"
        
        if [[ -n "${{ steps.auth.outputs.response }}" ]]; then
          echo "Authentication: ‚úÖ Success"
          DEPLOYED_SCHEMAS=$(find workflows -type f -name "*_schema.json" | wc -l)
          DEPLOYED_WORKFLOWS=$(find workflows -type f -name "*.json" ! -name "*_schema.json" ! -name "*_payload.json" | wc -l)
          echo "Processed Schemas: $DEPLOYED_SCHEMAS"
          echo "Processed Workflows: $DEPLOYED_WORKFLOWS"
        else
          echo "Authentication: ‚ùå Failed"
        fi
        
        if [[ "${{ job.status }}" == "success" ]]; then
          echo "‚úÖ Overall Status: Success"
          exit 0
        else
          echo "‚ùå Overall Status: Failed"
          exit 1
        fi